<?xml version="1.0" encoding="utf-8"?>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
  <!-- 2021-08-08 Sun 11:57 -->
  <meta http-equiv="Content-Type" content=
  "text/html; charset=utf-8" />
  <meta name="viewport" content=
  "width=device-width, initial-scale=1" />
  <title>‎</title>
  <meta name="author" content="Casper van Elteren" />
  <meta name="generator" content="Org Mode" />
  <style>
  <![CDATA[
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  ]]>
  </style>
  <script type="text/x-mathjax-config">
  <![CDATA[
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
  });
  ]]>
  </script>
  <script src=
  "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
  <div id="content" class="content">
    <div id="table-of-contents" role="doc-toc">
      <h2>Table of Contents</h2>
      <div id="text-table-of-contents" role="doc-toc">
        <ul>
          <li><a href="#orga2ca446">1. Introduction</a></li>
          <li><a href="#org3547b0c">2. Outline</a></li>
          <li><a href="#orgc61bd3d">3. ESP32</a></li>
          <li>
            <a href="#org9d1be4f">4. Matrix scanning</a>
            <ul>
              <li><a href="#orgaafcdf5">4.1. Ghosting</a></li>
              <li><a href="#org6758524">4.2. Key
              debouncing</a></li>
              <li><a href="#org35f4a17">4.3. Changes</a></li>
            </ul>
          </li>
          <li>
            <a href="#org8edcccf">5. ESP-Now</a>
            <ul>
              <li><a href="#orgb361a03">5.1. Mesh interface
              class</a></li>
              <li><a href="#orgfcad7f1">5.2. Changes</a></li>
            </ul>
          </li>
          <li>
            <a href="#org3fe97ea">6. Modifier keys</a>
            <ul>
              <li><a href="#org4ce8c34">6.1. Changes</a></li>
            </ul>
          </li>
          <li>
            <a href="#orgd6f9e27">7. Bluetooth</a>
            <ul>
              <li><a href="#org936d66d">7.1. Changes</a></li>
            </ul>
          </li>
          <li>
            <a href="#org7c77fb5">8. Keyboard layers</a>
            <ul>
              <li><a href="#org5d508fb">8.1. Changes</a></li>
            </ul>
          </li>
          <li>
            <a href="#org614b166">9. Rotary encoder</a>
            <ul>
              <li><a href="#org2ab8541">9.1. Taming the KY-040 with
              decoding</a></li>
              <li><a href="#org9a0ea00">9.2. Changes</a></li>
            </ul>
          </li>
          <li>
            <a href="#org8d9e9b9">10. OLED Display</a>
            <ul>
              <li><a href="#org6077f56">10.1. Changes</a></li>
            </ul>
          </li>
          <li>
            <a href="#org506c24c">11. Battery control</a>
            <ul>
              <li><a href="#orgec669e0">11.1. <span class=
              "todo ___">[-]</span> Deep sleep</a></li>
              <li><a href="#orgfae2486">11.2. Changes</a></li>
            </ul>
          </li>
          <li><a href="#orgaf70855">12. Backlog and weird behavior
          notes</a></li>
          <li><a href="#orgc33e5ea">13. Final checklist</a></li>
        </ul>
      </div>
    </div>
    <p><i>This is work in progress - the post is updated as I find
    time to work on it.</i></p>
    <div id="outline-container-orga2ca446" class="outline-2">
      <h2 id="orga2ca446"><span class="section-number-2">1.</span>
      Introduction</h2>
      <div class="outline-text-2" id="text-1">
        <p><span class="timestamp-wrapper"><span class=
        "timestamp">&lt;2021-06-21 Mon&gt;</span></span> Mechanical
        keyboards are somewhat of a dated concept that has gathered
        some speed in more recent years. Back when computers were
        first coming out for the public, keyboards had mechanical
        connections that would allow a current to activate a
        switch. Then as economics got wind, somehow we got used to
        membrane keyboards; virtually every office in the world has
        these membrane keyboards. Compared to mechanical keyboards,
        membrane keyboards feel more “mushy”. In contrast,
        mechanical keyboards may have different feel based on the
        springs or whether the key switch has a noticeable “bump”.
        They can be clicky or not; the possibility are wild
        now.</p>
        <p>A few years ago I started following the subreddit on
        mechanical keyboards. Back then, the community had little
        options and cherry still had patents on the switches.
        Cherry MX keys were virtually found in every commercial
        keyboard on the market. Now, the landscape has changed
        quite a bit and more and more different types of switches
        are available.</p>
        <p>Why do I prefer mechanical keyboards? Mechanical
        keyboards give a “joy” to typing. Membrane keyboards are
        fine to type on, but they aren’t fun. Generally my fingers
        get “tired” after typing on membrane keyboards as the keys
        feel a bit mushy, i.e. you get no relief when pushing down
        a key and the key press does not feel crisp.</p>
        <p>After following / r / mechanicalkeyboards for a while, I
        decided to <i>build</i> my own keyboard. Within the
        community, there is a wide variety of switches and shapes
        of keyboards available. The one I wanted, an orthonormal
        keyboard, wasn’t commercially available. Plus I liked the
        idea of building my own keyboard. In my work, the keyboard
        is my primary tool and why not key a custom version of it
        for myself. I ended up building 2 handwired versions of 65
        percent with 85 switches in a grid layout. In addition, I
        modded a MagSafe-inspired cable to it which allowed it to
        be nice and portable. After every build I told myself : “
        This is the last one I’ll build”.</p>
        <p>Enter this blog, where I again tell myself “this is the
        last one I build!”. What changed? Since I learned about
        split-style keyboard, I always wanted one. The keyboards I
        had made so far weren’t. Split would be completely
        ergonomical, but unfortunately, none (that I know of)
        exists that are both (a) wireless and (b) split. As always
        I aimed to high and wanted to emulate the many features
        that QMK implements. Most importantly, I wanted to get back
        into writing more low level languages like c++, and I take
        this project as a nice opportunity to get into c++ again,
        and work with micro-controllers.</p>
        <p>This post will serve as my log for building the
        keyboard. The post will updated as I work on it.</p>
        <p>Core feature targets</p>
        <ul class="org-ul">
          <li>Split <span class="underline">wireless</span>
          keyboard</li>
          <li>Hot swappable key sockets</li>
          <li>Portable, not a full keyboard</li>
          <li>Battery control</li>
          <li>OLED display</li>
          <li>Rotary encoders</li>
        </ul>
      </div>
    </div>
    <div id="outline-container-org3547b0c" class="outline-2">
      <h2 id="org3547b0c"><span class="section-number-2">2.</span>
      Outline</h2>
      <div class="outline-text-2" id="text-2">
        <p>The keyboard is split; it has two halves. The right and
        left half will have most of the same “base” functionality.
        Most importantly, each half needs to scan the matrix to
        obtain which keys are being pressed. One of the halves will
        act as a server, the other will act as a client. The server
        will need the following capabilities</p>
        <p><b>Server abilities</b></p>
        <ul class="org-ul">
          <li>Read matrix</li>
          <li>Setup a bluetooth connection
            <ul class="org-ul">
              <li>HID Device</li>
              <li>Mouse emulation</li>
            </ul>
          </li>
          <li>Setup connection with client
            <ul class="org-ul">
              <li>Merge keys pressed and send to bluetooth
              controller</li>
            </ul>
          </li>
          <li>Control LEDs on both client and server</li>
        </ul>
        <p><b>Client abilities</b></p>
        <ul class="org-ul">
          <li>Read matrix</li>
          <li>Find server and send pressed keys to server</li>
        </ul>
        <p>Due to the heavier load of the server, I prefer to make
        the role of who is server and who is client dynamic. That
        is, with some heuristic (for example deep sleep), the roles
        may switch to prolong batter life of both units.</p>
        <p>To give a course overview consider the following
        picture:</p>
        <div id="org60e4d64" class="figure">
          <p><img src="./figures/overview.png" class="img" /></p>
        </div>
      </div>
    </div>
    <div id="outline-container-orgc61bd3d" class="outline-2">
      <h2 id="orgc61bd3d"><span class="section-number-2">3.</span>
      ESP32</h2>
      <div class="outline-text-2" id="text-3">
        <p><span class="timestamp-wrapper"><span class=
        "timestamp">&lt;2021-07-12 Mon&gt;</span></span>- I opted
        for a micro-controller as this would allow me to prototype
        without worrying about my electronic skills. The controller
        needed to have battery control, bluetooth, and preferable
        an energy efficient screen; I ended up with an esp32.</p>
        <p>The esp32 is a hybrid chip that has both Wi-Fi and
        bluetooth capabilities. The esp32 consists of different
        versions that varies in (mainly) in the number of pins,
        battery connector, and or screen. The version I ended with
        (LORA-V2) had a battery connector and a tiny OLED
        screen.</p>
        <p>The ecosystem of ESP32 is well-developed albeit less
        convenient than its arduino counterparts. Luckily, the
        opensource community has taken it upon themselves to
        provide lots of arduino bindings to the libraries by
        espressif (manufacturer of esp32).</p>
        <p>Especially important (as it turned out later) is that
        the esp32 has the capabilities of using both Wi-Fi and
        bluetooth low energy simultanaously. In addition, through
        ESP-NOW, different eps32 modules can form a mesh, which I
        will harness to do server-client communication.</p>
        <div id="orgcedc37b" class="figure">
          <p><img src="./figures/pinout.jpg" alt=
          "pinout.jpg" /></p>
          <p><span class="figure-number">Figure 1:</span> Pin-out
          ESP32 LORA-V2</p>
        </div>
      </div>
    </div>
    <div id="outline-container-org9d1be4f" class="outline-2">
      <h2 id="org9d1be4f"><span class="section-number-2">4.</span>
      Matrix scanning</h2>
      <div class="outline-text-2" id="text-4">
        <p><span class="timestamp-wrapper"><span class=
        "timestamp">&lt;2021-07-12 Mon&gt;</span></span> A keyboard
        matrix scanning circuit is used to enhance the number of
        keys, while keeping the number of pins low. A
        micro-controller uses general pin input/output (GPIO) to
        register currents. If a singular key switch is wired to a
        single pin, 96 pins would be needed for a 104 sized
        keyboard (full-size). This would be unpractical.</p>
        <p>As an alternative one could apply matrix scanning. In
        this method, the keys are wired as a grid where each column
        connects to each row effectively forming a “switch”. For a
        total for 100 keys, one would need 10x10 grid. The grid
        acts as a force multiplier for the number of switches.
        Instead of needing 100 separate keys, we merely need 10
        rows and 10 columns (20 pins) to wire our 100 switch
        keyboard.</p>
        <p>The matrix is repeatedly scanned to determine if a row
        column form an open circuit. That is, if a key switch is
        pressed down, current can flow between the row and column.
        The scanning occurs at a high scan rate, making it
        seemingly instantaneous.</p>
      </div>
      <div id="outline-container-orgaafcdf5" class="outline-3">
        <h3 id="orgaafcdf5"><span class=
        "section-number-3">4.1.</span> Ghosting</h3>
        <div class="outline-text-3" id="text-4-1">
          <p>Matrix scanning forms an excellent idea to efficiently
          represent our electronic switches. However, merely
          scanning does not correctly records all key presses.
          Under some conditions, a matrix can record ghost keys,
          i.e. keys that are registered but not pressed. This
          process is called ghosting.</p>
          <p>Ghosting occurs when current can freely flow between
          separate rows or columns due to another row/column being
          open. For example consider a simple two row, two column
          keyboard. This board can support 4 keys. When two keys
          along the diagonal are pressed, we register 4 keys(!).
          This is obviously wrong and needs to be corrected. The
          most common approach is to put a diode right after the
          switch either on the columns or rows, which prevents
          current from traversing and causing ghosting.</p>
          <div id="orgbacdb1c" class="figure">
            <p><img src="./figures/ghosting.png" alt=
            "ghosting.png" /></p>
            <p><span class="figure-number">Figure 2:</span>
            Ghosting example. Ghosting occurs when current can flow
            freely across columns and rows. (Left) one key is
            pressed down bottom left. (Middle) A key across from
            the first is activated which causes ghosting (right);
            current flows from the second row, first column to the
            second row, second column etc.</p>
          </div>
        </div>
      </div>
      <div id="outline-container-org6758524" class="outline-3">
        <h3 id="org6758524"><span class=
        "section-number-3">4.2.</span> Key debouncing</h3>
        <div class="outline-text-3" id="text-4-2">
          <p>Key debounce is a mechanism to filter out erroneous
          key activity. When two metal plates come into contact,
          the signal does not form a clean square wave. In order to
          clean up this signal, key debouncing is used to reflect
          the “press” of key switch.</p>
        </div>
      </div>
      <div id="outline-container-org35f4a17" class="outline-3">
        <h3 id="org35f4a17"><span class=
        "section-number-3">4.3.</span> Changes</h3>
        <div class="outline-text-3" id="text-4-3">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code> Added matrix class
              <ul class="org-ul">
                <li class="on"><code>[X]</code> added matrix
                scan</li>
                <li class="on"><code>[X]</code> added key
                debounce</li>
                <li class="on">
                  <code>[X]</code> added (whole) matrix debounce
                  <ul class="org-ul">
                    <li class="on"><code>[X]</code> filters out
                    erroneous key presses</li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-org8edcccf" class="outline-2">
      <h2 id="org8edcccf"><span class="section-number-2">5.</span>
      ESP-Now</h2>
      <div class="outline-text-2" id="text-5">
        <p><span class="timestamp-wrapper"><span class=
        "timestamp">&lt;2021-06-19 Sat&gt;</span></span> The two
        halves need to communicate to eachother. There is only one
        half that is connected through bluetooth to another device.
        We call this the server, and the other the client. Keys
        pressed on the client needs to be communicated to the
        server which processes the keys, and sends it over
        bluetooth. Luckily, ESP-now offers a mesh interface we can
        utilize for this purpose. This is easier to setup than a
        bluetooth mesh interface and should be relatively secure
        for foreign attackers. From the website we read:</p>
        <blockquote>
          <p>ESP-NOW is yet another protocol developed by
          Espressif, which enables multiple devices to communicate
          with one another without using Wi-Fi. The protocol is
          similar to the low-power 2.4GHz wireless connectivity
          that is often deployed in wireless mouses. So, the
          pairing between devices is needed prior to their
          communication. After the pairing is done, the connection
          is secure and peer-to-peer, with no handshake being
          required.</p>
        </blockquote>
      </div>
      <div id="outline-container-orgb361a03" class="outline-3">
        <h3 id="orgb361a03"><span class=
        "section-number-3">5.1.</span> Mesh interface class</h3>
        <div class="outline-text-3" id="text-5-1">
          <p>The mesh class is responsible for:</p>
          <ul class="org-ul">
            <li>Setup / deinit the ESP-now connection</li>
            <li>Holding a buffer that is sent over the ESP-now
            connection. The buffer holds information that needs to
            be communicated between each halves.</li>
          </ul>
          <p>At the moment of writing, the mesh class holds a
          static buffer which holds `keyswitch<sub>t</sub>`. These
          are structs containing when the last time the pins were
          read as active. In addition, it contains information on
          the source and sinc pins, and column and row indices.
          These last two are used to index into the final keymap on
          the server side. This way, no actual key information is
          send, but the server reads the key from the col and row,
          then they are combined. This solves the issue of sending
          ascii shifted codes or media keys.</p>
        </div>
      </div>
      <div id="outline-container-orgfcad7f1" class="outline-3">
        <h3 id="orgfcad7f1"><span class=
        "section-number-3">5.2.</span> Changes</h3>
        <div class="outline-text-3" id="text-5-2">
          <ul class="org-ul">
            <li class="on"><code>[X]</code> Implemented mesh
            interface class</li>
            <li class="on"><code>[X]</code> Added server
            capabilities to join the keys from both half and
            communicate through bluetooth</li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-org3fe97ea" class="outline-2">
      <h2 id="org3fe97ea"><span class="section-number-2">6.</span>
      Modifier keys</h2>
      <div class="outline-text-2" id="text-6">
        <p><span class="timestamp-wrapper"><span class=
        "timestamp">&lt;2021-07-26 Mon&gt;</span></span> My initial
        implementation measures the onset of keys. That is,
        debounce worked by measuring when the “square wave” of the
        key was pressed. This allows for fast and accurate
        detection detecting key press down. Initially my intentions
        was to merge the other keys together such that multiple
        keys are registered at the same time. For example, the
        shift key needs to register two keys at minimum to shift
        the ascii code around for let’s say `a` to `A`.</p>
        <p>Consequently, I need to both register the key press down
        as well as the key release; I modified the debounce
        mechanism to also detect the key release.</p>
      </div>
      <div id="outline-container-org4ce8c34" class="outline-3">
        <h3 id="org4ce8c34"><span class=
        "section-number-3">6.1.</span> Changes</h3>
        <div class="outline-text-3" id="text-6-1">
          <ul class="org-ul">
            <li class="on"><code>[X]</code> Change key detection.
            Register key press and key release</li>
            <li class="on"><code>[X]</code> Mesh buffer management
            is moved out of the keyboard class.</li>
            <li class="on"><code>[X]</code> Fixed wrong indexing in
            reading the active keys on the server.</li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-orgd6f9e27" class="outline-2">
      <h2 id="orgd6f9e27"><span class="section-number-2">7.</span>
      Bluetooth</h2>
      <div class="outline-text-2" id="text-7">
        <p>Bluetooth is rather complicated. The Bluetooth Keyboard
        class takes care of most of the heavy lifting. Key codes
        have an associated ascii code, these are put into an ascii
        code map. Note that the over bluetooth (for whatever
        reason) these keycodes are remapped to different
        numbers.</p>
      </div>
      <div id="outline-container-org936d66d" class="outline-3">
        <h3 id="org936d66d"><span class=
        "section-number-3">7.1.</span> Changes</h3>
        <div class="outline-text-3" id="text-7-1">
          <ul class="org-ul">
            <li class="off"><code>[&nbsp;]</code> Expand this
            section with info on characteristics and services.</li>
            <li class="on"><code>[X]</code> Figure out how the key
            codes are organized The symbols are organized in a 128
            ascii keymap containing the hex codes to a symbol. Hex
            codes can be send directly in addition to normal
            strings over bluetooth. The modifier keys in
            combination with some media control keys are defined in
            “BleKeyboard.h”, the ascii map is in “BleKeyboard.cpp”.
            I have written a short wrapper in
            “key<sub>defintions.hpp</sub>”.</li>
            <li class="on">
              <code>[X]</code> Add functions for interfacing with
              bluetooth to the keyboard class
              <ul class="org-ul">
                <li class="on"><code>[X]</code> Pressing down
                keys</li>
                <li class="on"><code>[X]</code> Releasing keys</li>
              </ul>
            </li>
            <li class="off"><code>[&nbsp;]</code> Convert config
            class to static class</li>
            <li class="trans">
              <code>[-]</code> Write layer keymap for keyboard
              <ul class="org-ul">
                <li class="on"><code>[X]</code> Wrote qwerty base
                layer</li>
                <li class="off"><code>[&nbsp;]</code> Add fixed
                array check to the layers (add to constant config
                class steps)</li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-org7c77fb5" class="outline-2">
      <h2 id="org7c77fb5"><span class="section-number-2">8.</span>
      Keyboard layers</h2>
      <div class="outline-text-2" id="text-8">
        <p>A layer is implemented as a 2D vector for the moment,
        but will likely change in finalizing the keyboard. An
        active layer is set as a pointer to the current active
        layer. Each keyswitch has information on where in the grid
        they fit; keys are read by using these indices in the 2D
        vector. I did consider an unordered<sub>map</sub> use the
        keyswitch directly as an indicator. This could then be
        combined with pointers to make a layer dynamic, i.e.
        instead of having the concept of layers, each key has a
        different layer that can be accessed. This adds some
        complexity and I decided against this. The main reason is
        that the client side would then need to store information
        on what each keyswitch points to. This would increase
        communication between each halves if modifiers are used for
        example. I am afraid that this added communication is not
        as trivially solved, i.e. one needs to send modifier key
        across ESP-NOW and then shift all affected keys and when
        activated send this information back. The ESP-NOW channel
        is not designed for high information throughput.</p>
        <p>The keyboard is not going to be full size. That is,
        purely based on the number of keys, this keyboard will not
        be able to have a 1-to-1 mapping from symbol to keyswitch.
        Luckily, we can greatly increase the number of symbols on
        the keyboard by hosting the missing symbols on different
        layers. This means we have to implement a feature that
        allows one to switch between different layers. For example
        we may implement a layer up and layer down key, or allow to
        switch directly between different layers. In QMK is worked
        out by an `enum struct`. Layers are stacked on top of each
        other. This has the added feature of allowing a
        “transparent” key to access on a layer below. I wish to
        emulate this feature.</p>
        <p>I currently host my key layer as a 2d vector. In
        finalizing my build this may change to a fixed array size.
        As vectors can be arbitrary sized, I need to add a check to
        the vectors to not allow uses to define oddly sized arrays
        (which would lead to seg faults). This will be added to the
        finalized checks.</p>
        <p>In QMK layers are `enum` type, which means the layers
        are number and tracked through an int. Here, I will have an
        `active<sub>layer</sub>` which points to the
        `layer<sub>t</sub>` hosting the current active keys. With
        transparent keys I can imagine that this approach will not
        work.</p>
      </div>
      <div id="outline-container-org5d508fb" class="outline-3">
        <h3 id="org5d508fb"><span class=
        "section-number-3">8.1.</span> Changes</h3>
        <div class="outline-text-3" id="text-8-1">
          <ul class="org-ul">
            <li class="off">
              <code>[&nbsp;]</code> Implement key layers
              <ul class="org-ul">
                <li class="off">
                  <code>[&nbsp;]</code> KC<sub>TRANS</sub> accesses
                  key below the current layer
                  <ul class="org-ul">
                    <li class="off"><code>[&nbsp;]</code> This
                    effect may stack until a non-transparent key is
                    found</li>
                    <li class="off">
                      <code>[&nbsp;]</code> Layer switch keys
                      <ul class="org-ul">
                        <li class="off"><code>[&nbsp;]</code> Up
                        and down</li>
                      </ul>
                    </li>
                    <li class="off"><code>[&nbsp;]</code> Hold
                    layer switch key: similar to modifier keys,
                    these keys temporarily shift the key layer
                    while holding down this key.</li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-org614b166" class="outline-2">
      <h2 id="org614b166"><span class="section-number-2">9.</span>
      Rotary encoder</h2>
      <div class="outline-text-2" id="text-9">
        <p>The keyboard has two rotary encoder (one on each
        halves). The encoders I added were mostly as a gimmick, but
        can be used as slider controls for volume control and or
        scrolling.</p>
        <div id="orge1bef74" class="figure">
          <p><img src="./figures/encoder.png" alt=
          "encoder.png" /></p>
          <p><span class="figure-number">Figure 3:</span> (left)
          Schematic rotary encoder. The A and B pin are 90 degrees
          out of phase and produce a quadrature signal (right). In
          the rest state both A and B pin register 0. The
          quadrature encoding for the A and B pin are given in
          <a href="#encoder_scheme">encoder_scheme</a>.</p>
        </div>
        <p>The rotary encoder has two pins that are shifted 90
        degrees out of phase (see figure <a href=
        "#fig:encoder">fig:encoder</a>). Each click produces a
        quadrature signal that is fixed. Unknowingly I bought
        encoders that are extremely noisy (KY-040). When the
        encoder clicks, contacts are moved across a terminal. The
        signal produced are ideally two square offsets by 90
        degrees. In practice however, the signal debounces and
        produces more signal. They are three traditional ways of
        taming noisy signals</p>
        <ol class="org-ol">
          <li>Hardware filtering</li>
          <li>Digital filtering</li>
          <li>Decoding</li>
        </ol>
        <p>I don’t know much about the first method or last method.
        I initially tried method 2, i.e. measuring the pins,
        waiting for some time and measure again. This however did
        not correctly measure the rotations. I tried multiple
        libraries that used interrupt routines that did not end up
        correctly measuring the clicks of the encoder. Finally I
        found <a href=
        "https://www.best-microcontroller-projects.com/rotary-encoder.html">
        this blog post</a> which highlighted exactly the problem
        with the KY-040. The decoder method worked like a charm,
        but took some time to figure out. Below is the exploration
        I had trying to figure out how this code worked.</p>
      </div>
      <div id="outline-container-org2ab8541" class="outline-3">
        <h3 id="org2ab8541"><span class=
        "section-number-3">9.1.</span> Taming the KY-040 with
        decoding</h3>
        <div class="outline-text-3" id="text-9-1">
          <p>The quadrature signal per click produces a fixed
          output for either clockwise or anti-clockwise rotation.
          The encoder can be thought of as a fixed state machine
          that moves between different states (<a href=
          "#table_transition">table_transition</a>).</p>
          <table id="org8ce8957" border="2" cellspacing="0"
          cellpadding="6" rules="groups" frame="hsides">
            <colgroup>
              <col class="org-right" />
              <col class="org-right" />
              <col class="org-right" />
              <col class="org-right" />
              <col class="org-left" />
            </colgroup>
            <thead>
              <tr>
                <th scope="col" class="org-right">Current
                state</th>
                <th scope="col" class="org-right">&nbsp;</th>
                <th scope="col" class="org-right">New state</th>
                <th scope="col" class="org-right">&nbsp;</th>
                <th scope="col" class="org-left">Direction</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="org-right">A pin</td>
                <td class="org-right">B pin</td>
                <td class="org-right">A pin</td>
                <td class="org-right">B pin</td>
                <td class="org-left">&nbsp;</td>
              </tr>
            </tbody>
            <tbody>
              <tr>
                <td class="org-right">1</td>
                <td class="org-right">1</td>
                <td class="org-right">0</td>
                <td class="org-right">1</td>
                <td class="org-left">clockwise</td>
              </tr>
              <tr>
                <td class="org-right">0</td>
                <td class="org-right">1</td>
                <td class="org-right">0</td>
                <td class="org-right">0</td>
                <td class="org-left">clockwise</td>
              </tr>
              <tr>
                <td class="org-right">0</td>
                <td class="org-right">0</td>
                <td class="org-right">1</td>
                <td class="org-right">0</td>
                <td class="org-left">clockwise</td>
              </tr>
              <tr>
                <td class="org-right">1</td>
                <td class="org-right">0</td>
                <td class="org-right">1</td>
                <td class="org-right">1</td>
                <td class="org-left">clockwise</td>
              </tr>
              <tr>
                <td class="org-right">1</td>
                <td class="org-right">1</td>
                <td class="org-right">1</td>
                <td class="org-right">0</td>
                <td class="org-left">anti-clockwise</td>
              </tr>
              <tr>
                <td class="org-right">0</td>
                <td class="org-right">1</td>
                <td class="org-right">1</td>
                <td class="org-right">1</td>
                <td class="org-left">anti-clockwise</td>
              </tr>
              <tr>
                <td class="org-right">0</td>
                <td class="org-right">0</td>
                <td class="org-right">0</td>
                <td class="org-right">1</td>
                <td class="org-left">anti-clockwise</td>
              </tr>
              <tr>
                <td class="org-right">1</td>
                <td class="org-right">0</td>
                <td class="org-right">0</td>
                <td class="org-right">0</td>
                <td class="org-left">anti-clockwise</td>
              </tr>
            </tbody>
          </table>
          <p>In practice however, a noisy rotary encoder will also
          output some state transitions that are not allowed, e.g.
          11-&gt;00. In order to correctly read which direction the
          rotary encoder was turned in, a digital filter can be
          used. A simple filter would be something like</p>
          <p>\[ signal = (signal &lt;&lt; 1) | digitalRead(A_{pin})
          | 0xF000\]</p>
          <p>A signal is only read if the integer value reaches the
          all ones state, then resets and waits again. Trying this
          method did not end well for me. I ended up using sequence
          decoder; the pattern are listed in <a href=
          "#encoder_scheme">encoder_scheme</a>.</p>
          <p>We can group the current state and new state as a 4
          bit number, i.e. \(\\{a, b, a', b'\\}\) where \(a\),
          \(b\) are the current state of the A and B pin and
          \(a'\), \(b'\) are the new state of the A and B pin. This
          implies that 2<sup>4</sup> = 16 state transitions are
          possible and we only allow for 8 of these to occur (see
          table <a href=
          "#table_transition">table_transition</a>).</p>
          <table id="orgc9fd4d3" border="2" cellspacing="0"
          cellpadding="6" rules="groups" frame="hsides">
            <colgroup>
              <col class="org-right" />
              <col class="org-left" />
              <col class="org-left" />
              <col class="org-right" />
            </colgroup>
            <thead>
              <tr>
                <th scope="col" class="org-right">state (bit
                mask)</th>
                <th scope="col" class="org-left">Allowed</th>
                <th scope="col" class="org-left">Direction</th>
                <th scope="col" class="org-right">State</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="org-right">0000</td>
                <td class="org-left">False</td>
                <td class="org-left">&nbsp;</td>
                <td class="org-right">0</td>
              </tr>
              <tr>
                <td class="org-right">0001</td>
                <td class="org-left">True</td>
                <td class="org-left">clockwise</td>
                <td class="org-right">1</td>
              </tr>
              <tr>
                <td class="org-right">0010</td>
                <td class="org-left">True</td>
                <td class="org-left">anti-clockwise</td>
                <td class="org-right">2</td>
              </tr>
              <tr>
                <td class="org-right">0011</td>
                <td class="org-left">False</td>
                <td class="org-left">&nbsp;</td>
                <td class="org-right">3</td>
              </tr>
              <tr>
                <td class="org-right">0100</td>
                <td class="org-left">True</td>
                <td class="org-left">clockwise</td>
                <td class="org-right">4</td>
              </tr>
              <tr>
                <td class="org-right">0101</td>
                <td class="org-left">False</td>
                <td class="org-left">&nbsp;</td>
                <td class="org-right">5</td>
              </tr>
              <tr>
                <td class="org-right">0110</td>
                <td class="org-left">False</td>
                <td class="org-left">&nbsp;</td>
                <td class="org-right">6</td>
              </tr>
              <tr>
                <td class="org-right">0111</td>
                <td class="org-left">True</td>
                <td class="org-left">anti-clockwise</td>
                <td class="org-right">7</td>
              </tr>
              <tr>
                <td class="org-right">1000</td>
                <td class="org-left">True</td>
                <td class="org-left">anti-clockwise</td>
                <td class="org-right">8</td>
              </tr>
              <tr>
                <td class="org-right">1001</td>
                <td class="org-left">False</td>
                <td class="org-left">&nbsp;</td>
                <td class="org-right">9</td>
              </tr>
              <tr>
                <td class="org-right">1010</td>
                <td class="org-left">False</td>
                <td class="org-left">&nbsp;</td>
                <td class="org-right">10</td>
              </tr>
              <tr>
                <td class="org-right">1011</td>
                <td class="org-left">True</td>
                <td class="org-left">clockwise</td>
                <td class="org-right">11</td>
              </tr>
              <tr>
                <td class="org-right">1100</td>
                <td class="org-left">False</td>
                <td class="org-left">&nbsp;</td>
                <td class="org-right">12</td>
              </tr>
              <tr>
                <td class="org-right">1101</td>
                <td class="org-left">True</td>
                <td class="org-left">clockwise</td>
                <td class="org-right">13</td>
              </tr>
              <tr>
                <td class="org-right">1110</td>
                <td class="org-left">True</td>
                <td class="org-left">anti-clockwise</td>
                <td class="org-right">14</td>
              </tr>
              <tr>
                <td class="org-right">1111</td>
                <td class="org-left">False</td>
                <td class="org-left">&nbsp;</td>
                <td class="org-right">15</td>
              </tr>
            </tbody>
          </table>
          <table id="org4ab4b8b" border="2" cellspacing="0"
          cellpadding="6" rules="groups" frame="hsides">
            <colgroup>
              <col class="org-left" />
              <col class="org-right" />
              <col class="org-left" />
            </colgroup>
            <thead>
              <tr>
                <th scope="col" class="org-left">Bitmask</th>
                <th scope="col" class="org-right">Hex</th>
                <th scope="col" class="org-left">Direction</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="org-left">0001 0111</td>
                <td class="org-right">0x17</td>
                <td class="org-left">clockwise</td>
              </tr>
              <tr>
                <td class="org-left">0010 1011</td>
                <td class="org-right">0x2b</td>
                <td class="org-left">anti-clockwise</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div id="outline-container-org9a0ea00" class="outline-3">
        <h3 id="org9a0ea00"><span class=
        "section-number-3">9.2.</span> Changes</h3>
        <div class="outline-text-3" id="text-9-2">
          <ul class="org-ul">
            <li class="on"><code>[X]</code> Add rotary encoder to
            keyboard class</li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-org8d9e9b9" class="outline-2">
      <h2 id="org8d9e9b9"><span class="section-number-2">10.</span>
      OLED Display</h2>
      <div class="outline-text-2" id="text-10"></div>
      <div id="outline-container-org6077f56" class="outline-3">
        <h3 id="org6077f56"><span class=
        "section-number-3">10.1.</span> Changes</h3>
        <div class="outline-text-3" id="text-10-1">
          <ul class="org-ul">
            <li class="off"><code>[&nbsp;]</code> Start creating
            interface for display management</li>
            <li class="off">
              <code>[&nbsp;]</code> Find interesting functions to
              put on the screen
              <ul class="org-ul">
                <li class="off"><code>[&nbsp;]</code> WiFi
                notifications?</li>
                <li class="off">
                  <code>[&nbsp;]</code> Keyboard status info
                  <ul class="org-ul">
                    <li class="off"><code>[&nbsp;]</code> Keyboard
                    layer info</li>
                    <li class="off"><code>[&nbsp;]</code> Battery
                    level info</li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-org506c24c" class="outline-2">
      <h2 id="org506c24c"><span class="section-number-2">11.</span>
      Battery control</h2>
      <div class="outline-text-2" id="text-11"></div>
      <div id="outline-container-orgec669e0" class="outline-3">
        <h3 id="orgec669e0"><span class=
        "section-number-3">11.1.</span> <span class=
        "todo ___">[-]</span> Deep sleep</h3>
        <div class="outline-text-3" id="text-11-1">
          <p>When not in use I aim to put the keyboard in deep
          sleep. Some pins on the esp32 can be used to wakeup the
          keyboard from deep sleep. The RTC<sub>GPIO</sub> pins and
          Touch pins can be used for waking the device from deep
          sleep. The RTC pins are</p>
          <table id="org27a794f" border="2" cellspacing="0"
          cellpadding="6" rules="groups" frame="hsides">
            <colgroup>
              <col class="org-left" />
              <col class="org-left" />
              <col class="org-left" />
            </colgroup>
            <thead>
              <tr>
                <th scope="col" class="org-left">RTC Pin</th>
                <th scope="col" class="org-left">GPIO</th>
                <th scope="col" class="org-left">Comment</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="org-left">RTC GPIO12</td>
                <td class="org-left">GPIO02</td>
                <td class="org-left">had issues with encoder</td>
              </tr>
              <tr>
                <td class="org-left">RTC GPIO10</td>
                <td class="org-left">GPIO04</td>
                <td class="org-left">OLED SDA</td>
              </tr>
              <tr>
                <td class="org-left">RTC GPIO15</td>
                <td class="org-left">GPIO12</td>
                <td class="org-left">&nbsp;</td>
              </tr>
              <tr>
                <td class="org-left">RTC GPIO14</td>
                <td class="org-left">GPIO13</td>
                <td class="org-left">&nbsp;</td>
              </tr>
              <tr>
                <td class="org-left">RTC GPIO16</td>
                <td class="org-left">GPIO14</td>
                <td class="org-left">&nbsp;</td>
              </tr>
              <tr>
                <td class="org-left">RTC GPIO13</td>
                <td class="org-left">GPIO15</td>
                <td class="org-left">OLED SLK</td>
              </tr>
              <tr>
                <td class="org-left">RTC GPIO9</td>
                <td class="org-left">GPIO32</td>
                <td class="org-left">input only</td>
              </tr>
              <tr>
                <td class="org-left">RTC GPIO8</td>
                <td class="org-left">GPIO33</td>
                <td class="org-left">input only</td>
              </tr>
              <tr>
                <td class="org-left">RTC GPIO4</td>
                <td class="org-left">GPIO34</td>
                <td class="org-left">input only</td>
              </tr>
              <tr>
                <td class="org-left">RTC GPIO5</td>
                <td class="org-left">GPIO35</td>
                <td class="org-left">input only</td>
              </tr>
              <tr>
                <td class="org-left">RTC GPIO0</td>
                <td class="org-left">GPIO36</td>
                <td class="org-left">input only</td>
              </tr>
              <tr>
                <td class="org-left">RTC GPIO3</td>
                <td class="org-left">GPIO39</td>
                <td class="org-left">input only</td>
              </tr>
              <tr>
                <td class="org-left">RTC GPIO6</td>
                <td class="org-left">GPIO25</td>
                <td class="org-left">&nbsp;</td>
              </tr>
              <tr>
                <td class="org-left">RTC GPIO7</td>
                <td class="org-left">GPIO26</td>
                <td class="org-left">&nbsp;</td>
              </tr>
              <tr>
                <td class="org-left">RTC GPIO17</td>
                <td class="org-left">GPIO27</td>
                <td class="org-left">&nbsp;</td>
              </tr>
              <tr>
                <td class="org-left">RTC GPIO11</td>
                <td class="org-left">GPIO00</td>
                <td class="org-left">button pin(?)</td>
              </tr>
            </tbody>
          </table>
          <p>The set GPIO12/13/14/25/26/27 could form a set for
          which all the columns or rows will have a key that is
          connected to deep sleep; this would mean either the rows
          or the columns are connected to a pin that is reachable
          from deep sleep. I will have to run some experiments if
          that could allow the keyboard to wake up from deep sleep,
          i.e. if the the column or row is not active I wonder if
          the the current will be low, i.e. if the pins are in deep
          sleep and a small current is tested on the active pins
          (set above), does the current go from HIGH to LOW?
          Alternatively, I could connect the pins to the set 3x
          range only for deep sleep mode.</p>
          <p>There are two sleep modes; light sleep and deep sleep.
          For light sleep the internal state of the system is
          preserved, which is not the case for deep sleep. This
          would mean that for deep sleep the keyboard effectively
          reboots.</p>
        </div>
      </div>
      <div id="outline-container-orgfae2486" class="outline-3">
        <h3 id="orgfae2486"><span class=
        "section-number-3">11.2.</span> Changes</h3>
        <div class="outline-text-3" id="text-11-2">
          <ul class="org-ul">
            <li class="off"><code>[&nbsp;]</code> Implement battery
            control</li>
            <li class="off"><code>[&nbsp;]</code> Implement deep
            sleep</li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-orgaf70855" class="outline-2">
      <h2 id="orgaf70855"><span class="section-number-2">12.</span>
      Backlog and weird behavior notes</h2>
      <div class="outline-text-2" id="text-12">
        <ul class="org-ul">
          <li>Pressing down a key repeatedly and then another key
          afterwards, stops sending the initially pressed down key.
          For example holding down `a` and then pressing any other
          key (including modifies) stops sending `a`.</li>
          <li>Figure out bug where `-` is sent repeatedly. This
          occurs especially when sending `a` key. I think it is
          related to the ascii code for for `a` and `-`.</li>
          <li>Figure out bug where ’up arrow’ is sent repeatedly.
          This occurs when the keyboard is connected to bluetooth.
          No keys are send on my part.</li>
          <li>Connecting the rotary encoder to GPIO1, GPIO3 causes
          odd symbols to appear when rotating. In addition, when
          set in a particular condition it will cause the rotary
          encoder to fail to upload code. This effect is gone with
          an additional turn. Apparently, the esp32 has some flaw
          in it that some pins are sensitive to inputs when
          uploading code. More info can be found here <a href=
          "https://github.com/espressif/arduino-esp32/issues/1497">https://github.com/espressif/arduino-esp32/issues/1497</a>.
          I have changed pin 1 to pin 2 which seemed to have fixed
          the issue.</li>
        </ul>
      </div>
    </div>
    <div id="outline-container-orgc33e5ea" class="outline-2">
      <h2 id="orgc33e5ea"><span class="section-number-2">13.</span>
      Final checklist</h2>
      <div class="outline-text-2" id="text-13">
        <p>Check that the following components work:</p>
        <ul class="org-ul">
          <li class="off">
            <code>[&nbsp;]</code> Matrix
            <ul class="org-ul">
              <li class="off"><code>[&nbsp;]</code> Does scanning
              work?</li>
              <li class="off"><code>[&nbsp;]</code> Does ghosting
              occur?</li>
            </ul>
          </li>
          <li class="off">
            <code>[&nbsp;]</code> ESPNOW
            <ul class="org-ul">
              <li class="off"><code>[&nbsp;]</code> Does the
              wireless bridge work?</li>
            </ul>
          </li>
          <li class="off">
            <code>[&nbsp;]</code> Bluetooth
            <ul class="org-ul">
              <li class="off"><code>[&nbsp;]</code> Is the unit
              detected as a keyboard?</li>
            </ul>
          </li>
          <li class="off">
            <code>[&nbsp;]</code> Rotary encoder
            <ul class="org-ul">
              <li class="off"><code>[&nbsp;]</code> Are single
              ticks detected?</li>
              <li class="off"><code>[&nbsp;]</code> Are both
              positive as well as negative clicks detected?</li>
              <li class="off"><code>[&nbsp;]</code> Does the esp32
              flash irregardless of the rotary encoder
              position?</li>
            </ul>
          </li>
          <li class="off">
            <code>[&nbsp;]</code> LEDs
            <ul class="org-ul">
              <li class="off"><code>[&nbsp;]</code> Can colors be
              encoded?</li>
              <li class="off"><code>[&nbsp;]</code> No shorting to
              ground?</li>
            </ul>
          </li>
          <li class="off">
            <code>[&nbsp;]</code> Display
            <ul class="org-ul">
              <li class="off"><code>[&nbsp;]</code> Do they display
              the GUI?</li>
            </ul>
          </li>
          <li class="off">
            <code>[&nbsp;]</code> PCB
            <ul class="org-ul">
              <li class="off"><code>[&nbsp;]</code> Are all the
              components connected?</li>
              <li class="off"><code>[&nbsp;]</code> Is the ground
              plate present?</li>
              <li class="off"><code>[&nbsp;]</code> Are the pins
              present with enough clearance?</li>
            </ul>
          </li>
          <li class="off">
            <code>[&nbsp;]</code> Software hardware interface
            <ul class="org-ul">
              <li class="off"><code>[&nbsp;]</code> verify that no
              pins are used that will cause issues, for example
              input pins in the 3x range.</li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div id="postamble" class="status">
    <p class="author">Author: Casper van Elteren</p>
    <p class="date">Created: 2021-08-08 Sun 11:57</p>
  </div>
</body>
</html>
