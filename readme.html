<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
  <!-- 2021-07-12 Mon 08:29 -->
  <meta http-equiv="Content-Type" content=
  "text/html; charset=utf-8" />
  <meta name="viewport" content=
  "width=device-width, initial-scale=1" />
  <title>‎</title>
  <meta name="author" content="Casper van Elteren" />
  <meta name="generator" content="Org Mode" />
  <style type="text/css">
  <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
  </style>
  <script type="text/javascript">
  // @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
  <!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
  // @license-end
  </script>
</head>
<body>
  <div id="content">
    <div id="table-of-contents">
      <h2>Table of Contents</h2>
      <div id="text-table-of-contents">
        <ul>
          <li><a href="#orge452f89">1. Introduction</a></li>
          <li><a href="#orgad82d5a">2. Outline</a></li>
          <li><a href="#org2bc9c6a">3. ESP32</a></li>
          <li>
            <a href="#orgfc18d38">4. Matrix scanning</a>
            <ul>
              <li><a href="#org9d21540">4.1. Ghosting</a></li>
              <li><a href="#org6759277">4.2. Key
              debouncing</a></li>
            </ul>
          </li>
          <li><a href="#org5232250">5. ESP-Now</a></li>
          <li><a href="#org11bd4db">6. Bluetooth</a></li>
          <li><a href="#org4467c98">7. OLED Display</a></li>
          <li><a href="#org94998eb">8. Battery control</a></li>
        </ul>
      </div>
    </div>
    <div id="outline-container-orge452f89" class="outline-2">
      <h2 id="orge452f89"><span class="section-number-2">1</span>
      Introduction</h2>
      <div class="outline-text-2" id="text-1">
        <p>Mechanical keyboards are somewhat of a dated concept
        that has gathered some speed in more recent years. Back
        when computers were first coming out for the public,
        keyboards had mechanical connections that would allow a
        current to activate a switch. Then as economics got wind,
        somehow we got used to membrane keyboards; virtually every
        office in the world has these membrane keyboards. Compared
        to mechanical keyboards, membrane keyboards feel more
        “mushy”. In contrast, mechanical keyboards may have
        different feel based on the springs or whether the key
        switch has a noticeable “bump”. They can be clicky or not;
        the possibility are wild now.</p>
        <p>A few years ago I started following the subreddit on
        mechanical keyboards. Back then, the community had little
        options and cherry still had patents on the switches.
        Cherry MX keys were virtually found in every commercial
        keyboard on the market. Now, the landscape has changed
        quite a bit and more and more different types of switches
        are available.</p>
        <p>Why do I prefer mechanical keyboards? Mechanical
        keyboards give a “joy” to typing. Membrane keyboards are
        fine to type on, but they aren’t fun. Generally my fingers
        get “tired” after typing on membrane keyboards as the keys
        feel a bit mushy, i.e. you get no relief when pushing down
        a key and the key press does not feel crisp.</p>
        <p>After following / r / mechanicalkeyboards for a while, I
        decided to <i>build</i> my own keyboard. Within the
        community, there is a wide variety of switches and shapes
        of keyboards available. The one I wanted, an orthonormal
        keyboard, wasn’t commercially available. Plus I liked the
        idea of building my own keyboard. In my work, the keyboard
        is my primary tool and why not key a custom version of it
        for myself. I ended up building 2 handwired versions of 65
        percent with 85 switches in a grid layout. In addition, I
        modded a MagSafe-inspired cable to it which allowed it to
        be nice and portable. After every build I told myself : “
        This is the last one I’ll build”.</p>
        <p>Enter this blog, where I again tell myself “this is the
        last one I build!”. What changed? Since I learned about
        split-style keyboard, I always wanted one. The keyboards I
        had made so far weren’t. Split would be completely
        ergonomical, but unfortunately, none (that I know of)
        exists that are both (a) wireless and (b) split. As always
        I aimed to high and wanted to emulate the many features
        that QMK implements. Most importantly, I wanted to get back
        into writing more low level languages like c++, and I take
        this project as a nice opportunity to get into c++ again,
        and work with micro-controllers.</p>
        <p>This post will serve as my log for building the
        keyboard. The post will updated as I work on it.</p>
        <p>Core feature targets</p>
        <ul class="org-ul">
          <li>Split <span class="underline">wireless</span>
          keyboard</li>
          <li>Hot swappable key sockets</li>
          <li>Portable, not a full keyboard</li>
          <li>Battery control</li>
          <li>OLED display</li>
          <li>Rotary encoders</li>
        </ul>
      </div>
    </div>
    <div id="outline-container-orgad82d5a" class="outline-2">
      <h2 id="orgad82d5a"><span class="section-number-2">2</span>
      Outline</h2>
      <div class="outline-text-2" id="text-2">
        <p>The keyboard is split; it has two halves. The right and
        left half will have most of the same “base” functionality.
        Most importantly, each half needs to scan the matrix to
        obtain which keys are being pressed. One of the halves will
        act as a server, the other will act as a client. The server
        will need the following capabilities</p>
        <p>Server abilities</p>
        <ul class="org-ul">
          <li>Read matrix</li>
          <li>Setup a bluetooth connection
            <ul class="org-ul">
              <li>HID Device</li>
              <li>Mouse emulation</li>
            </ul>
          </li>
          <li>Setup connection with client
            <ul class="org-ul">
              <li>Merge keys pressed and send to bluetooth
              controller</li>
            </ul>
          </li>
          <li>Control LEDs on both client and server</li>
        </ul>
        <p>Client abilities</p>
        <ul class="org-ul">
          <li>Read matrix</li>
          <li>Find server and send pressed keys to server</li>
        </ul>
        <p>Due to the heavier load of the server, I prefer to make
        the role of who is server and who is client dynamic. That
        is, with some heuristic (for example deep sleep), the roles
        may switch to prolong batter life of both units.</p>
        <p>To give a course overview consider the following
        picture:</p>
        <div id="orgd701180" class="figure">
          <p><img src="./figures/overview.png" class="img" /></p>
        </div>
      </div>
    </div>
    <div id="outline-container-org2bc9c6a" class="outline-2">
      <h2 id="org2bc9c6a"><span class="section-number-2">3</span>
      ESP32</h2>
      <div class="outline-text-2" id="text-3">
        <p>I opted for a micro-controller as this would allow me to
        prototype without worrying about my electronic skills. The
        controller needed to have battery control, bluetooth, and
        preferable an energy efficient screen; I ended up with an
        esp32.</p>
        <p>The esp32 is a hybrid chip that has both Wi-Fi and
        bluetooth capabilities. The esp32 consists of different
        versions that varies in (mainly) in the number of pins,
        battery connector, and or screen. The version I ended with
        (LORA-V2) had a battery connector and a tiny OLED
        screen.</p>
        <p>The ecosystem of ESP32 is well-developed albeit less
        convenient than its arduino counterparts. Luckily, the
        opensource community has taken it upon themselves to
        provide lots of arduino bindings to the libraries by
        espressif (manufacturer of esp32).</p>
        <p>Especially important (as it turned out later) is that
        the esp32 has the capabilities of using both Wi-Fi and
        bluetooth low energy simultanaously. In addition, through
        ESP-NOW, different eps32 modules can form a mesh, which I
        will harness to do server-client communication.</p>
        <div id="orgbd69923" class="figure">
          <p><img src="./figures/pinout.jpg" alt=
          "pinout.jpg" /></p>
          <p><span class="figure-number">Figure 2:</span> Pin-out
          ESP32 LORA-V2</p>
        </div>
      </div>
    </div>
    <div id="outline-container-orgfc18d38" class="outline-2">
      <h2 id="orgfc18d38"><span class="section-number-2">4</span>
      Matrix scanning</h2>
      <div class="outline-text-2" id="text-4">
        <p>A keyboard matrix scanning circuit is used to enhance
        the number of keys, while keeping the number of pins low. A
        micro-controller uses general pin input/output (GPIO) to
        register currents. If a singular key switch is wired to a
        single pin, 96 pins would be needed for a 104 sized
        keyboard (full-size). This would be unpractical.</p>
        <p>As an alternative one could apply matrix scanning. In
        this method, the keys are wired as a grid where each column
        connects to each row effectively forming a “switch”. For a
        total for 100 keys, one would need 10x10 grid. The grid
        acts as a force multiplier for the number of switches.
        Instead of needing 100 separate keys, we merely need 10
        rows and 10 columns (20 pins) to wire our 100 switch
        keyboard.</p>
        <p>The matrix is repeatedly scanned to determine if a row
        column form an open circuit. That is, if a key switch is
        pressed down, current can flow between the row and column.
        The scanning occurs at a high scan rate, making it
        seemingly instantaneous.</p>
      </div>
      <div id="outline-container-org9d21540" class="outline-3">
        <h3 id="org9d21540"><span class=
        "section-number-3">4.1</span> Ghosting</h3>
        <div class="outline-text-3" id="text-4-1">
          <p>Matrix scanning forms an excellent idea to efficiently
          represent our electronic switches. However, merely
          scanning does not correctly records all key presses.
          Under some conditions, a matrix can record ghost keys,
          i.e. keys that are registered but not pressed. This
          process is called ghosting.</p>
          <p>Ghosting occurs when current can freely flow between
          separate rows or columns due to another row/column being
          open. For example consider a simple two row, two column
          keyboard. This board can support 4 keys. When two keys
          along the diagonal are pressed, we register 4 keys(!).
          This is obviously wrong and needs to be corrected. The
          most common approach is to put a diode right after the
          switch either on the columns or rows, which prevents
          current from traversing and causing ghosting.</p>
          <div id="org67a9b43" class="figure">
            <p><img src="./figures/ghosting.png" alt=
            "ghosting.png" /></p>
            <p><span class="figure-number">Figure 3:</span>
            Ghosting example. Ghosting occurs when current can flow
            freely across columns and rows. (Left) one key is
            pressed down bottom left. (Middle) A key across from
            the first is activated which causes ghosting (right);
            current flows from the second row, first column to the
            second row, second column etc.</p>
          </div>
        </div>
      </div>
      <div id="outline-container-org6759277" class="outline-3">
        <h3 id="org6759277"><span class=
        "section-number-3">4.2</span> Key debouncing</h3>
        <div class="outline-text-3" id="text-4-2">
          <p>Key debounce is a mechanism to filter out erroneous
          key activity. When two metal plates come into contact,
          the signal does not form a clean square wave. In order to
          clean up this signal, key debouncing is used to reflect
          the “press” of key switch.</p>
        </div>
      </div>
    </div>
    <div id="outline-container-org5232250" class="outline-2">
      <h2 id="org5232250"><span class="section-number-2">5</span>
      ESP-Now</h2>
      <div class="outline-text-2" id="text-5"></div>
    </div>
    <div id="outline-container-org11bd4db" class="outline-2">
      <h2 id="org11bd4db"><span class="section-number-2">6</span>
      Bluetooth</h2>
    </div>
    <div id="outline-container-org4467c98" class="outline-2">
      <h2 id="org4467c98"><span class="section-number-2">7</span>
      OLED Display</h2>
    </div>
    <div id="outline-container-org94998eb" class="outline-2">
      <h2 id="org94998eb"><span class="section-number-2">8</span>
      Battery control</h2>
    </div>
  </div>
  <div id="postamble" class="status">
    <p class="author">Author: Casper van Elteren</p>
    <p class="date">Created: 2021-07-12 Mon 08:29</p>
  </div>
</body>
</html>
